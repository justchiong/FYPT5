<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kodo</title>
    <link rel="shortcut icon" type="image/jpg" href="/kodoLogo.png" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
        integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
    <link rel="stylesheet" href="/summary.css">
</head>

<body class="mb-5">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns" crossorigin="anonymous">
    </script>
    <div class="container-fluid px-0">
        <nav class="navbar navbar-expand-sm bg-light navbar-light justify-content-end fixed-top">
            <!--bg-light navbar-light-->
            <!-- Links -->
            <ul class="navbar-nav pl-5 navbar-fonts" id="appendNavItem">
                <li class="nav-item mx-1 ">
                    <a class="nav-link navlinkcolor" href="./summary.html">Results</a>
                </li>
                <li class="nav-item mx-1 ">
                    <a class="nav-link navlinkcolor" href="./dashboard.html">Scanner</a>
                </li>
                <li class="nav-item mx-1 ">
                    <a class="nav-link navlinkcolor" href="#">Contact Us</a>
                </li>
            </ul>
            <a class="navbar-brand" href="#">
                <img src="./Logo/kodoLogo.png" width="45" height="45" class="d-inline-block align-top mx-2" alt="">
            </a>
        </nav>
    </div>
    <div class="jumbotron jumboStyle">
        <div class="container pl-10">
            <h1 class="display-3 mt-5" style="font-weight: bold;">
                Results <img src="/kodoLogo.png" width="100" height="100" class="d-inline-block align-top mx-2" alt="">
            </h1>
            <p class="lead">Enter your unique result access-key here:</p>
            <div class="input-group mb-3 w-50">
                <form class="input-group-append w-100" id="getResults">
                    <input type="text" class="form-control w-75" placeholder="access-key from email"
                    aria-label="access-key from email" aria-describedby="button-addon2" id="accesskey" required pattern="^[0-9A-Fa-f]{8}-[0-9A-Fa-f]{4}-[4][0-9A-Fa-f]{3}-[89ABab][0-9A-Fa-f]{3}-[0-9A-Fa-f]{12}$">
                    <button class="btn btn-success w-25" type="submit" id="button-addon2">Retrieve</button>
                </form>
            </div>
        </div>
    </div>
    <div class="container" id="contain123" style="width: 100vw;">
        <div class="card-deck">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">BASIC SCAN INFORMATION</h6>
                    <h5 class="card-title">Information</h5>
                    <p class="card-text">
                        <p><span class="badge badge-primary">&nbsp;&nbsp;File&nbsp;&nbsp;</span><br><div id="zipName">Kodo.zip</div></p>
                        <p><span class="badge badge-primary">&nbsp;&nbsp;MD5
                                Hash&nbsp;&nbsp;</span><br><div id="md5">22932655a6ad0b8020aa2abac66d4bb8</div></p>
                        <p><span class="badge badge-warning">&nbsp;&nbsp;Total No. of Issues:&nbsp;&nbsp;</span><span
                                style="font-size:19px;padding-left: 8px;" id="totalIssues">18</span></p>
                    </p>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">DISTRIBUTION OF SEVERTITY BY ISSUE TYPES</h6>
                    <h5 class="card-title">Severity</h5>
                    <p class="card-text">
                        <canvas id="severityCanvas" height="190"></canvas>
                    </p>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">CWE DISTRIBUTION</h6>
                    <h5 class="card-title">Vulnerabilities</h5>
                    <p class="card-text">
                        <canvas id="vulnCanvas" height="190"></canvas>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="accordion" class="container-fluid mt-4">
        <div class="card kodo-yellow" id="addResultAfter">
            <div class="card-header" id="headingOne">
                <h5 class="mb-0">
                    <button class="btn w-100" style="height: 2.5em;">
                        <table class="table table-borderless text-left">
                            <tr style="font-weight: bold;">
                                <td class="column1 tableheader">Vulnerability</td>
                                <td class="column2 tableheader">Description</td>
                                <td class="column3 tableheader">Severity</td>
                            </tr>
                        </table>
                    </button>
                </h5>
            </div>
        </div>
    </div>
</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous">
</script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.1/styles/sunburst.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.1/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js">
</script>
<script>
    baseUrl = "http://localhost:3000"

    var sevC = document.getElementById('severityCanvas').getContext('2d');
    var vulnC = document.getElementById('vulnCanvas').getContext('2d');
    var sevCvar = new Chart(sevC, {
        type: 'pie',
        data: {
            labels: ['Error', 'Warning', 'Recommendation'],
            datasets: [{
                label: 'Error',
                data: [12, 19, 3],
                backgroundColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(54, 162, 235, 1)'
                ],
                borderColor: [
                    'rgba(135, 135, 135,0.6)',
                    'rgba(135, 135, 135,0.6)',
                    'rgba(135, 135, 135,0.6)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            maintainAspectRatio: false, //important for scaling to work properly
            animation: {
                duration: 10000,
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    var vulnCvar = new Chart(vulnC, {
        type: 'line',
        data: {
            labels: ['A1:(INJ)', 'A2:(XSS)', 'A3:(SM)', 'A4:(SDE)', 'A5:(BA)', 'A6:(XXE)', 'A7:(BAC)', 'A8:(ID)', 'A9:(ABC)','A10:(DEF)'],
            datasets: [{
                label: '# of vuln',
                data: [12, 19, 3, 4, 30, 12,1,5,9,4],
                backgroundColor: 'rgba(255, 71,71,0.5)',
                pointBackgroundColor: [
                '#e6194B', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#42d4f4', '#f032e6', '#bfef45', '#fabed4'
                ],
                pointBorderColor: [
                '#000000'
                ],
                borderWidth: 1
            }]
        },
        options: {
            maintainAspectRatio: false, //important for scaling to work properly
            animation: {
                duration: 10000
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    hljs.initLineNumbersOnLoad();

    function updateChart(chart, newData) {
        chart.data.datasets[0].data = []
        chart.data.datasets[0].data = newData
        chart.update();
    }
    //post request to give app.js the accesskey and retrieve params
    //get request to give app.js the accesskey and retrieve params
    $("#getResults").submit((event) => {
        event.preventDefault()
        $('#addResultAfter').nextAll().remove() //remove all existing rows
        const requestBody = {
            accesskey: $("#accesskey").val()
        }
        console.log($("#accesskey").val())
        axios.get(`${baseUrl}/request/results/${$("#accesskey").val()}`)
            .then((response) => {
                var allResults = response.data.results
                // var allGeneral = allResults.general[0]
                console.log(allResults)

                // allResults = allResults.results
                // sevCdata = [allGeneral.totalErrors, allGeneral.totalWarns, allGeneral.totalRecomms]
                sevCdata = []
                vulnCdata = []
                for(num=0;num<10;num++){
                    ranNum = Math.floor(Math.random() * (20 - 3) + 3)
                    vulnCdata.push(ranNum)
                }
                for(num2=0;num2<3;num2++){
                    ranNum = Math.floor(Math.random() * (20 - 3) + 3)
                    sevCdata.push(ranNum)
                }
                updateChart(sevCvar,sevCdata)
                updateChart(vulnCvar,vulnCdata)
                // document.getElementById('zipName').innerHTML = allGeneral.zipName
                // document.getElementById('md5').innerHTML = allGeneral.md5
                // document.getElementById('totalIssues').innerHTML = allGeneral.totalIssues

                document.getElementById('accordion').scrollIntoView()
                count = 0
                for (var result in allResults) {
                    result = allResults[result]
                    count = count + 1
                    var resultRowHTML = `
            <!--Start of row ${count} result-->
            <div class="card cardhover">
                <div class="card-header" id="heading${count}">
                    <h5 class="mb-0">
                        <button class="btn collapsed w-100" data-toggle="collapse" data-target="#collapse${count}"
                            aria-expanded="false" aria-controls="collapse${count}">
                            <table class="table table-borderless text-left yellowtext">
                                <thead>
                                    <tr style="font-weight: bold;">
                                        <td class="column1">${result.vulnerability}</td>
                                        <td class="column2">${result.description}</td>
                                        <td class="column3"><span class="badge badge-pill badge-${result.severityColor}">${result.severity}</span></td>
                                    </tr>
                                </thead>
                            </table>
                        </button>
                    </h5>
                </div>
                <div id="collapse${count}" class="collapse" aria-labelledby="heading${count}" data-parent="#accordion">
                    <div class="card-body px-5 kodo-gray">
                        <p><span>Description:&nbsp;&nbsp;</span>${result.description}</p>
                        <p><span>Severity:&nbsp;&nbsp;</span><span class="badge badge-pill badge-${result.severityColor}">${result.severity}</span></p>
                        <p><span>OWASP:&nbsp;&nbsp;</span>${result.owasp}</p>
                        <p><span>CWE:&nbsp;&nbsp;</span>${result.cwe}</p>
                        <br>
                        <p><span>File Path:&nbsp;&nbsp;</span>${result.filepath}</p>
                        <p><span>Line [start:end]:&nbsp;&nbsp;</span>${result.line}</p>
                        <!--EMBEDDED CODE starts here note: code needs to be added to the leftmost(as shown below) without tabbing for it to display on webpage properly-->
                        <pre><code data-ln-start-from="${result.lineStart}">
${result.codeCopied}
                        </code></pre>
                    </div>
                </div>
            </div>
        <!--End of row ${count} result-->`
                    document.getElementById("addResultAfter").insertAdjacentHTML("afterend", resultRowHTML)
                    hljs.highlightAll();
                    hljs.initLineNumbersOnLoad();
                }

            })
            .catch((err) => {
                console.log(err)
            })
    })
</script>

</html>